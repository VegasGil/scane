<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Filtro de Rutas PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f6f8;
      padding: 2em;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    #controls {
      text-align: center;
      margin-bottom: 1em;
    }

    input[type="file"], button {
      font-size: 1em;
      padding: 0.5em 1em;
      margin: 0.5em;
    }

    #status {
      text-align: center;
      font-weight: bold;
      color: #0078d4;
      margin-bottom: 1em;
    }

    #routes {
      background: #fff;
      padding: 1em;
      border-radius: 8px;
    }

    .route {
      padding: 0.5em;
      margin: 0.5em 0;
      border-left: 5px solid #0078d4;
      background: #eef;
    }

    .route.not-found {
      background-color: #ffe5e5;
      border-left: 4px solid red;
    }

    hr {
      margin: 2em 0;
      border: none;
      border-top: 2px dashed #ccc;
    }
  </style>
</head>
<body>
  <h1>üì¶ Filtro de Rutas PDF</h1>

  <div id="controls">
    <input type="file" id="fileInput" multiple accept="application/pdf" />
    <button onclick="extractText()">üìù Leer PDFs</button>
    <button onclick="descargarDAT()">üì• Guardar como .dat</button>
  </div>
  
  <div id="controls">
   <div id="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:999;">
  <div id="modalContent" style="background:white;padding:2em;border-radius:8px;max-width:500px;text-align:center;"></div>
</div>
    
  </div>


  <div id="status">Esperando archivo PDF...</div>
  <div id="routes"></div>

  <script>
    let pdfDocs = [];
    let rutasPermitidas = [];
    let rutasSinDeposito = [];

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      pdfDocs = [];
      document.getElementById('status').textContent = `üìÇ Cargando ${files.length} PDF(s)...`;

      for (const file of files) {
        const reader = new FileReader();
        reader.onload = async function () {
          const typedarray = new Uint8Array(this.result);
          try {
            const doc = await pdfjsLib.getDocument({ data: typedarray }).promise;
            pdfDocs.push({ name: file.name, doc });
            document.getElementById('status').textContent = `‚úÖ ${pdfDocs.length}/${files.length} PDF(s) listos`;
          } catch (err) {
            console.error(`‚ùå Error al cargar ${file.name}:`, err);
          }
        };
        reader.readAsArrayBuffer(file);
      }
    });

    async function extractText() {
      if (pdfDocs.length === 0) return alert('Carga uno o m√°s PDFs primero');
      let textoExtraido = [];

      for (const { name, doc } of pdfDocs) {
        for (let i = 1; i <= doc.numPages; i++) {
          const page = await doc.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str).join(' ');
          textoExtraido.push(strings);
        }
      }

      const texto = textoExtraido.join('\n\n');
      analizarRutas(texto);
    }

    function analizarRutas(texto) {
      const regex = /Arxiu:\s*(.+?)\s*Tipus:\s*(\S+)\s*Dip√≤sit:\s*(\d*)?\s*Pis:\s*(\d*)?\s*Carrer:\s*(\d*)?\s*Columna:\s*(\d*)?\s*Nivell:\s*(\d*)?\s*Serie:\s*(\d*)?\s*Contenidor:\s*(\d+)/gi;
      rutasPermitidas = [];
      rutasSinDeposito = [];
      let match;
      const depositosPermitidos = ['45', '46', '47', '48', '49'];

      while ((match = regex.exec(texto)) !== null) {
        const depositoRaw = match[3]?.trim() || '';
        const ruta = {
          arxiu: match[1],
          deposito: depositoRaw,
          piso: match[4] || '',
          carrer: match[5] || '',
          columna: match[6] || '',
          nivell: match[7] || '',
          contenedor: match[9]
        };

        if (depositosPermitidos.includes(depositoRaw)) {
          rutasPermitidas.push(ruta);
        } else if (depositoRaw === '' || depositoRaw === '0') {
          rutasSinDeposito.push(ruta);
        }
      }

      mostrarResumen();
    }

    function mostrarResumen() {
      const container = document.getElementById('routes');
      container.innerHTML = '';

      if (rutasPermitidas.length > 0) {
        container.innerHTML += '<h2>‚úÖ Rutas con dep√≥sito permitido</h2>';
        rutasPermitidas.forEach(r => {
          container.innerHTML += `
            <div class="route">
              <strong>Contenedor:</strong> ${r.contenedor}<br>
              <strong>Arxiu:</strong> ${r.arxiu}<br>
              <strong>Dep√≥sito:</strong> ${r.deposito} | <strong>Pis:</strong> ${r.piso}<br>
              <strong>Carrer:</strong> ${r.carrer} | <strong>Columna:</strong> ${r.columna} | <strong>Nivell:</strong> ${r.nivell}
            </div>
          `;
        });
      }

      if (rutasSinDeposito.length > 0) {
        container.innerHTML += '<hr><h2>‚ùå Rutas sin dep√≥sito (0 o vac√≠o)</h2>';
        rutasSinDeposito.forEach(r => {
          container.innerHTML += `
            <div class="route not-found">
              <strong>Contenedor:</strong> ${r.contenedor}<br>
              <strong>Arxiu:</strong> ${r.arxiu}<br>
              <strong>Dep√≥sito:</strong> ${r.deposito || 'Vac√≠o'}<br>
              <strong>Pis:</strong> ${r.piso || 'Sin dato'}<br>
              <strong>Carrer:</strong> ${r.carrer || 'Sin dato'}<br>
              <strong>Columna:</strong> ${r.columna || 'Sin dato'}<br>
              <strong>Nivell:</strong> ${r.nivell || 'Sin dato'}<br>
              ‚ö†Ô∏è Requiere revisi√≥n
            </div>
          `;
        });
      }

      document.getElementById('status').textContent = `‚úÖ ${rutasPermitidas.length} v√°lidas | ‚ùå ${rutasSinDeposito.length} sin ubicaci√≥n`;
    }

   function descargarDAT() {
  if (rutasPermitidas.length === 0 && rutasSinDeposito.length === 0) {
    alert("No hay rutas para guardar.");
    return;
  }

  const fecha = new Date();
  const yyyy = fecha.getFullYear();
  const mm = String(fecha.getMonth() + 1).padStart(2, '0');
  const dd = String(fecha.getDate()).padStart(2, '0');
  const fechaTexto = `${dd}/${mm}/${yyyy}`;

  let contenido = '';

  if (rutasPermitidas.length > 0) {
    contenido += '‚úÖ Rutas con dep√≥sito permitido:\n\n';
    contenido += rutasPermitidas.map(r => {
      return `Contenedor: ${r.contenedor}\nArxiu: ${r.arxiu}\nDep√≥sito: ${r.deposito} | Pis: ${r.piso}\nCarrer: ${r.carrer} | Columna: ${r.columna} | Nivell: ${r.nivell}\n${fechaTexto}`;
    }).join('\n\n');
  }
  if (rutasSinDeposito.length > 0) {
    contenido += '\n\n‚ùå Rutas sin dep√≥sito (0 o vac√≠o):\n\n';
    contenido += rutasSinDeposito.map(r => {
      return `Contenedor: ${r.contenedor}\nArxiu: ${r.arxiu}\nDep√≥sito: ${r.deposito || 'Vac√≠o'}\nPis: ${r.piso || 'Sin dato'}\nCarrer: ${r.carrer || 'Sin dato'}\nColumna: ${r.columna || 'Sin dato'}\nNivell: ${r.nivell || 'Sin dato'}\n‚ùå Pendiente de revisi√≥n ${fechaTexto}`;
    }).join('\n\n');
  }

  const nombreArchivo = `rutas_filtradas_${yyyy}-${mm}-${dd}.dat`;
  const blob = new Blob([contenido], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);

  // Mostrar modal con opciones
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  content.innerHTML = `<h2>üì§ ¬øQu√© deseas hacer con el archivo?</h2>`;

  // Bot√≥n de descarga
  const descargarBtn = document.createElement('button');
  descargarBtn.textContent = 'üì• Descargar archivo .dat';
  descargarBtn.style = 'width:100%;padding:1em;margin-top:1em;';
  descargarBtn.onclick = () => {
    const link = document.createElement('a');
    link.href = url;
    link.download = nombreArchivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    // modal.style.display = 'none';
  };
  content.appendChild(descargarBtn);

  // Bot√≥n Gmail
  const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=vegasf@outlook.com&su=Rutas filtradas&body=Adjunto archivo generado: ${nombreArchivo}`;
  const gmailBtn = document.createElement('button');
  gmailBtn.textContent = 'üìß Enviar por Gmail';
  gmailBtn.style = 'width:100%;padding:1em;margin-top:0.5em;';
  gmailBtn.onclick = () => window.open(gmailLink, '_blank');
  content.appendChild(gmailBtn);

  // Bot√≥n Outlook / gen√©rico
  const mailtoLink = `mailto:vegasf@outlook.com?subject=Rutas filtradas&body=Adjunto archivo generado: ${nombreArchivo}`;
  const outlookBtn = document.createElement('button');
  outlookBtn.textContent = 'üì® Enviar por Outlook u otro';
  outlookBtn.style = 'width:100%;padding:1em;margin-top:0.5em;';
  outlookBtn.onclick = () => window.location.href = mailtoLink;
  content.appendChild(outlookBtn);

  // Bot√≥n cerrar
  const cerrarBtn = document.createElement('button');
  cerrarBtn.textContent = '‚ùå Cancelar';
  cerrarBtn.style = 'width:100%;padding:1em;margin-top:1em;background:#ccc;';
  cerrarBtn.onclick = () => modal.style.display = 'none';
  content.appendChild(cerrarBtn);

  modal.style.display = 'flex';
}
  </script>
</body>
</html>