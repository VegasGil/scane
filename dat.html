<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Palets (.dat)</title>
  <style>
    :root {
      --rojo: #d32f2f;
      --gris: #6e6c6c;
      --gris-claro: #f4f4f4;
      --blanco: #fff;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--gris-claro);
      color: var(--gris);
    }

    header {
      background: var(--rojo);
      color: var(--blanco);
      padding: 1em 1.5em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
    }

    header .brand a {
      text-decoration: none;
      color: var(--blanco);
      font-size: 1.4rem;
      font-weight: bold;
      letter-spacing: 1px;
    }

    main {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: var(--rojo);
      margin: 1em 0;
      font-size: 1.6rem;
    }

    input, button, select {
      padding: 10px;
      margin: 10px 5px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      cursor: pointer;
      background: var(--rojo);
      color: var(--blanco);
      border: none;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #b71c1c;
    }

    #result, #listado {
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      margin-top: 20px;
      border-radius: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    #acciones {
      margin-top: 20px;
    }

   /* üîé Filtros y Listados */
#filtros {
  margin-top: 2em;
  padding: 1em;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#filtros h3 {
  margin-bottom: 1em;
  color: var(--rojo);
}

#filtros button,
#filtros select {
  margin: 0.5em 0.5em 0.5em 0;
  padding: 10px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}

#filtros button {
  background: var(--rojo);
  color: var(--blanco);
  border: none;
  cursor: pointer;
}

#filtros button:hover {
  background: #b71c1c;
}

#modalAviso {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

#modalAviso .contenido {
  background: white;
  padding: 30px;
  border-radius: 8px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.3s ease, opacity 0.3s ease;

}

#modalAviso button {
  margin: 10px;
  padding: 10px 14px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

#modalAviso button:first-of-type {
  background: #4CAF50;
  color: white;
}

#modalAviso button:last-of-type {
  background: #aaa;
  color: white;
}

#modalAviso button:hover {
  opacity: 0.9;
}
section {
  margin-top: 2em;
}
@media (max-width: 600px) {
  main {
    padding: 10px;
  }

  h1 {
    font-size: 1.2rem;
    margin: 0.8em 0;
  }

  input, button, select,
  #filtros button,
  #filtros select {
    width: 100%;
    margin: 8px 0;
    font-size: 1rem;
  }

  #result, #listado {
    padding: 10px;
    font-size: 0.95rem;
  }

  table {
    font-size: 0.9rem;
  }

  th, td {
    padding: 6px;
  }

  header .brand a {
    font-size: 1.1rem;
  }

  #filtros {
    padding: 0.8em;
  }

  #modalAviso .contenido {
    padding: 20px;
  }
}
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <a href="index.html">ARADOC ARTES</a>
    </div>
  </header>
  <main>
    <h1>Gesti√≥n de Palets (.dat)</h1>

    <input type="file" id="fileInput" accept=".dat">
    <button onclick="generarEstructura()">Generar estructura</button>
    <br>
    <input type="text" id="searchInput" placeholder="Buscar referencia">
    <button onclick="buscar()">Buscar</button>

    <div id="result"></div>

    <div id="acciones" style="display:none;">
      <label>Acci√≥n:
        <select id="accion">
          <option value="prestamo">Pr√©stamo</option>
          <option value="devolucion">Devoluci√≥n</option>
        </select>
      </label>
      <label>Fecha:
        <input type="date" id="fecha">
      </label>
      <button onclick="aplicarCambio()">Aplicar cambio</button>
      <button onclick="guardarArchivo()">Guardar archivo</button>
    </div>
  </main>

<hr>
<div id="filtros">
  <h3>Filtros y Listados</h3>
  <button onclick="listarTodo()">Listar todo</button>
  <button onclick="filtrarEstado('PRESTAMO')">Ver pr√©stamos</button>
  <button onclick="filtrarEstado('DEVOLUCION')">Ver devoluciones</button>
  <select id="pasilloSelect" onchange="filtrarPasillo()">
    <option value="">Filtrar por pasillo</option>
  </select>
  <select id="paletSelect" onchange="filtrarPalet()">
    <option value="">Filtrar por palet</option>
  </select>
</div>

<div id="listado"></div>

<div id="modalAviso">
  <div class="contenido">
    <h3>‚ö†Ô∏è Cambios sin guardar</h3>
    <p>Hay modificaciones pendientes. ¬øDeseas guardar antes de continuar?</p>
    <button onclick="guardarArchivo(); cerrarModal()">Guardar y continuar</button>
    <button onclick="cerrarModal()">Continuar sin guardar</button>
  </div>
</div>

    <script>
        let referencias = [];
        let estructura = [];
        let archivoNombre = 'archivo.dat';
        let lineaSeleccionada = -1;
        let estructuraModificada = false;

document.getElementById('fileInput').addEventListener('change', function () {
  const file = this.files[0];
  archivoNombre = file.name;
  const reader = new FileReader();

  reader.onload = function () {
    const contenido = reader.result.split('\n').map(r => r.trim()).filter(r => r !== '');

    const contieneEstructura = contenido.some(line => line.includes('| ESTADO:'));
    const contienePalets = contenido.some(line => /^\d+-PALET-\d+/.test(line));

    if (contieneEstructura) {
      estructura = contenido;
      estructuraModificada = false;
      actualizarPasillos();
      alert("‚úÖ Archivo cargado con estructura modificada. Listo para consultar.");
    } else if (contienePalets) {
      referencias = contenido;
      estructura = [];
      estructuraModificada = false;
      alert("üìÑ Archivo cargado en formato original. Genera estructura para modificar.");
    } else {
      referencias = [];
      estructura = [];
      alert("‚ö†Ô∏è El archivo no tiene formato v√°lido. No se puede procesar.");
    }
  };

  reader.readAsText(file);
});

     function generarEstructura() {
  estructura = [];
  let referenciasTemporales = [];
  let ubicacionActual = '';

  referencias.forEach(linea => {
    const texto = linea.trim();

    // Detecta cualquier l√≠nea tipo "n-PALET-m" como ubicaci√≥n
    if (/^\d+-PALET-\d+/.test(texto)) {
      ubicacionActual = texto;

      // Asocia todas las referencias acumuladas al palet actual
      referenciasTemporales.forEach(ref => {
        estructura.push(`${ubicacionActual} ${ref} | ESTADO: DISPONIBLE`);
      });

      referenciasTemporales = [];
    } else {
      referenciasTemporales.push(texto);
    }
  });

  // Procesa referencias finales si el archivo termina sin nueva ubicaci√≥n
  if (ubicacionActual && referenciasTemporales.length > 0) {
    referenciasTemporales.forEach(ref => {
      estructura.push(`${ubicacionActual} ${ref} | ESTADO: DISPONIBLE`);
    });
  }

  estructuraModificada = true;
  actualizarPasillos();
  alert("Estructura generada por referencia individual.");
}
        function calcularEstado(linea) {
            const tienePrestamo = linea.includes('PRESTAMO');
            const tieneDevolucion = linea.includes('DEVOLUCION');
            return (tienePrestamo && !tieneDevolucion) ? 'PRESTADO' : 'DISPONIBLE';
        }

        function buscar() {
            if (estructuraModificada) {
                mostrarModal();
                return;
            }

            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            lineaSeleccionada = estructura.findIndex(line => line.toLowerCase().includes(query));
            const resultDiv = document.getElementById('result');

            if (lineaSeleccionada === -1) {
                resultDiv.innerHTML = '<strong>No encontrado</strong>';
                document.getElementById('acciones').style.display = 'none';
            } else {
                const partes = estructura[lineaSeleccionada].split(' ');
                const ubicacion = partes[0];
                const referencia = partes[1];
                const estado = calcularEstado(estructura[lineaSeleccionada]);
                resultDiv.innerHTML = `<strong>Referencia encontrada:</strong><br>Ubicaci√≥n: ${ubicacion}<br>Referencia: ${referencia}<br>Estado: ${estado}`;
                document.getElementById('acciones').style.display = 'block';
            }
        }
        function aplicarCambio() {
            if (lineaSeleccionada === -1) return;
            const accion = document.getElementById('accion').value;
            const fecha = document.getElementById('fecha').value;
            let linea = estructura[lineaSeleccionada];

            const partes = linea.split(' ');
            const ubicacion = partes[0];
            const referencia = partes[1];

            // Limpiar campos anteriores
            let campos = linea.split('|')
                .map(c => c.trim())
                .filter(c => !c.startsWith('ESTADO:') && !c.startsWith('PRESTAMO') && !c.startsWith('DEVOLUCION') && c !== `${ubicacion} ${referencia}`);

            // Agregar nueva acci√≥n
            if (accion === 'prestamo') {
                campos.push(`PRESTAMO ${fecha}`);
            } else if (accion === 'devolucion') {
                campos.push(`DEVOLUCION ${fecha}`);
            }

            // Determinar estado
            const tienePrestamo = accion === 'prestamo';
            const tieneDevolucion = accion === 'devolucion';
            const nuevoEstado = (tienePrestamo && !tieneDevolucion) ? 'ESTADO: PRESTADO' : 'ESTADO: DISPONIBLE';

            // Reconstruir l√≠nea
            const nuevaLinea = `${ubicacion} ${referencia} | ${nuevoEstado} | ${campos.join(' | ')}`;
            estructura[lineaSeleccionada] = nuevaLinea;
            estructuraModificada = true;
            buscar();
        }

        function guardarArchivo() {
            const contenido = estructura.join('\n');
            const blob = new Blob([contenido], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = archivoNombre;
            link.click();
            estructuraModificada = false;
        }

        function mostrarModal() {
            document.getElementById('modalAviso').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalAviso').style.display = 'none';
            estructuraModificada = false;
            buscar();
        }

        function listarTodo() {
            mostrarListado(estructura);
        }

        function filtrarEstado(estado) {
            const filtrado = estructura.filter(line => line.includes(estado));
            mostrarListado(filtrado);
        }

        function actualizarPasillos() {
            const pasilloSelect = document.getElementById('pasilloSelect');
            const paletSelect = document.getElementById('paletSelect');

            pasilloSelect.innerHTML = '<option value="">Filtrar por pasillo</option>';
            paletSelect.innerHTML = '<option value="">Filtrar por palet</option>';

            const ubicaciones = [...new Set(estructura.map(line => line.split(' ')[0]))];
            const pasillos = [...new Set(ubicaciones.map(u => u.split('-')[0]))];

            pasillos.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = `Pasillo ${p}`;
                pasilloSelect.appendChild(option);
            });

            ubicaciones.forEach(palet => {
                const option = document.createElement('option');
                option.value = palet;
                option.textContent = palet;
                paletSelect.appendChild(option);
            });
        }
        function filtrarPalet() {
            const palet = document.getElementById('paletSelect').value;
            if (!palet) return;
            const filtrado = estructura.filter(line => line.startsWith(palet));
            mostrarListado(filtrado);
        }
        function filtrarPasillo() {
            const pasillo = document.getElementById('pasilloSelect').value;
            if (!pasillo) return;
            const filtrado = estructura.filter(line => line.startsWith(pasillo + '-'));
            mostrarListado(filtrado);
        }
        function mostrarListado(lista) {
            const div = document.getElementById('listado');
            if (lista.length === 0) {
                div.innerHTML = '<strong>No hay resultados</strong>';
                return;
            }

            let html = '<table><thead><tr><th>Ubicaci√≥n</th><th>Referencia</th><th>Estado</th><th>Pr√©stamo</th><th>Devoluci√≥n</th></tr></thead><tbody>';
            lista.forEach((line) => {
                const partes = line.split(' ');
                const ubicacion = partes[0];
                const referencia = partes.slice(1).join(' ').split('|')[0].trim();
                const estado = calcularEstado(line);
                const fechaPrestamo = (line.match(/PRESTAMO\s(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
                const fechaDevolucion = (line.match(/DEVOLUCION\s(\d{4}-\d{2}-\d{2})/) || [])[1] || '';

                html += `<tr onclick="seleccionarReferencia('${referencia}')">
          <td>${ubicacion}</td>
          <td>${referencia}</td>
          <td>${estado}</td>
          <td>${fechaPrestamo}</td>
          <td>${fechaDevolucion}</td>
        </tr>`;
            });
            html += '</tbody></table>';
            div.innerHTML = html;
        }

        function seleccionarReferencia(ref) {
            document.getElementById('searchInput').value = ref;
            buscar();
        }
    </script>
</body>

</html>