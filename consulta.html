<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üì¶ Revisi√≥n de Rutas ‚Äî Rojo / Gris / Blanco</title>
  <style>
    :root{
      --brand-red: #ea0707; /* rojo marca */
      --brand-deep: #8b0000;
      --brand-mid: #727070;
      --brand-light: #f5f5f5;
      --white: #ffffff;
      --text: #222222;
    }

    *{box-sizing: border-box}
    body{
      margin:0; padding:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,var(--brand-light), #f7f7f7);
      color:var(--text);
      min-height:100vh;
      display:flex; flex-direction:column;
    }

    header{
      background: var(--brand-red);
      color:var(--white);
      padding:0.9rem 1rem;
      display:flex; align-items:center; gap:1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .brand {
      font-weight:700; font-size:1.05rem;
      letter-spacing:0.6px;
    }

    main{flex:1; padding:1rem; display:flex; flex-direction:column; align-items:center}

    .card{
      width:100%; max-width:980px; background:var(--white); border-radius:12px; padding:1rem;
      box-shadow:0 6px 20px rgba(0,0,0,0.04); margin-top:1rem;
    }

    #controls{display:flex; flex-direction:column; gap:0.75rem; align-items:center}

    /* custom file input */
    .file-wrap{width:100%; max-width:600px; display:flex; gap:0.75rem; align-items:center}
    .file-label{
      flex:1; display:flex; align-items:center; justify-content:center; gap:0.5rem;
      padding:0.9rem 1rem; border-radius:10px; background:var(--white);
      border:2px dashed var(--brand-mid); color:var(--brand-deep); cursor:pointer; font-weight:600;
    }
    .file-label:hover{background:#fff7f7}
    input[type=file]{display:none}

    .controls-row{display:flex; gap:0.75rem; width:100%; max-width:600px}
    .btn{flex:1; padding:0.9rem 1rem; border-radius:10px; border:none; cursor:pointer; font-weight:700}
    .btn-primary{background:var(--brand-red); color:var(--white)}
    .btn-secondary{background:var(--white); color:var(--brand-red); border:2px solid var(--brand-red)}

    #status{margin-top:0.75rem; font-weight:700; color:var(--brand-deep)}

    /* modal */
    #modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:999}
    #modalContent{width:100%; max-width:520px; background:var(--white); border-radius:14px; padding:1.25rem; box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    #modalContent h2{margin-top:0}

    /* deposit buttons (toggle) */
    .deposit-list{display:flex; flex-wrap:wrap; gap:0.6rem; justify-content:center; margin-top:0.6rem}
    .deposit-btn{padding:0.6rem 0.85rem; border-radius:10px; border:2px solid var(--brand-mid); background:var(--white); cursor:pointer; font-weight:700}
    .deposit-btn.active{background:var(--brand-red); color:var(--white); border-color:var(--brand-deep)}

    /* confirmadas list */
    #confirmadas{margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem; width:100%; max-width:980px}
    .confirmada{padding:0.95rem; border-radius:10px; font-weight:600}
    .confirmada.encontrada{background:linear-gradient(90deg,var(--white), #fffaf9); border-left:6px solid var(--brand-red); color:var(--text)}
    .confirmada.no-encontrada{background:#fff0f0; border-left:6px solid var(--brand-deep); color:var(--brand-deep)}

    footer{padding:1rem; text-align:center; color:#666; font-size:0.95rem}

    @media (max-width:700px){
      .controls-row{flex-direction:column}
      .file-wrap{flex-direction:column; align-items:stretch}
      .file-label{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="index.html" style="text-decoration: none; color: white;">ARADOC ARTES</a></div>
    <div style="margin-left:auto;font-weight:600;opacity:0.95">üì¶ Revisi√≥n de Rutas</div>
  </header>

  <main>
    <div class="card" role="region" aria-label="Controles principales">
      <div id="controls">
        <div class="file-wrap">
          <label class="file-label" for="fileInput">üìÅ Seleccionar archivo .dat</label>
          <input id="fileInput" type="file" accept=".dat,.pdf" multiple />
        </div>

        <div class="controls-row">
          <button class="btn btn-primary" onclick="mostrarModalFinal()">üì• Opciones / Descargar</button>
          <button class="btn btn-secondary" onclick="reiniciar()">üîÑ Reiniciar</button>
        </div>

        <div id="status">üìÇ Esperando archivo .dat...</div>
      </div>
    </div>

    <div id="confirmadas" aria-live="polite"></div>
    <div id="resumen" style="margin-top:2rem; font-weight:600;"></div>
  </main>

  <div id="modal" aria-hidden="true">
    <div id="modalContent"></div>
  </div>
<button class="btn btn-primary" onclick="iniciarRevision()">üì¶ Iniciar revisi√≥n</button>

  <footer>¬© 2025 ARADOC ARTES ‚Äî Colores corporativos: rojo ¬∑ gris ¬∑ blanco</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

// ===== ESTADO GLOBAL =====
let rutas = [];              
let rutasFiltradas = [];     
let rutasConfirmadas = [];   
let depositosSeleccionados = [];
let actualIndex = 0;

// ===== PARSEAR BLOQUES =====
function parsearRutas(texto, origen = 'DAT') {
  const clean = (texto || '').replace(/\r/g, '');
  const bloques = clean.split(/-{3,}|\n\s*\n/).map(b => b.trim()).filter(Boolean);
  const salida = [];

  for (const b of bloques) {
    const fields = {};
    const pairRe = /([^\n:|]+):\s*([^|\n\r]+)/g;
    let m;
    while ((m = pairRe.exec(b)) !== null) {
      const key = m[1].trim();
      const val = m[2].trim();
      fields[key] = val;
    }

    if (!Object.values(fields).some(v => /\d{2}\/\d{2}\/\d{4}/.test(v))) {
      const dateMatch = b.match(/\d{2}\/\d{2}\/\d{4}/);
      if (dateMatch) fields['Data'] = dateMatch[0];
    }

    const map = {};
    for (const k in fields) {
      const kn = k.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/\s+/g, '');
      map[kn] = fields[k];
    }

    const get = (...variants) => {
      for (let v of variants) {
        const vn = v.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/\s+/g, '');
        if (map[vn] !== undefined) return map[vn];
      }
      return '';
    };

    const contenedor = get('contenidor','contendor','contenedor'); 
    const arxiu = get('arxiu','archivo'); 
    const deposito = get('diposit','dip√≤sit','deposit','deposito'); 
    const piso = get('pis','piso');
    const carrer = get('carrer','carrer','carrera','calle');
    const columna = get('columna'); 
    const nivell = get('nivell','nivel');
    const client = get('client','cliente');
    const fecha = get('data','fecha') || '';
    const codigoBarras = get('codigobarras','codbarras','codigo','codigo barras');

    if (contenedor) {
      salida.push({
        contenedor, arxiu, deposito, piso, carrer, columna, nivell,
        client, fecha, codigoBarras, origen, Estado: ''
      });
    }
  }

  return salida;
}

// ===== FILTRAR POR DEP√ìSITO =====
function filtrarPorDeposito(rutas, permitidos = ['45','46','47','48','49']) {
  const permitidas = [];
  const sinDeposito = [];

  rutas.forEach(r => {
    const dep = r.deposito?.trim() || '';
    if (permitidos.includes(dep)) permitidas.push(r);
    else if (dep === '' || dep === '0') sinDeposito.push(r);
  });

  return { permitidas, sinDeposito };
}

// ===== MOSTRAR MODAL DE SELECCI√ìN =====
function mostrarModalSeleccion(depositos) {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  depositosSeleccionados = [];

  let html = `<h2>Selecciona dep√≥sitos a revisar</h2><div class="deposit-list">`;
  depositos.forEach(d => {
    html += `<button class="deposit-btn" onclick="toggleDeposito('${d}', this)">Dep√≥sito ${d}</button>`;
  });
  html += `</div>
  <div style="margin-top:1rem; display:flex; gap:0.6rem;">
    <button class="btn btn-primary" style="flex:1" onclick="confirmarSeleccion()">Comenzar revisi√≥n</button>
    <button class="btn btn-secondary" style="flex:1" onclick="cerrarModal()">Cancelar</button>
  </div>`;

  content.innerHTML = html;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

function toggleDeposito(valor, boton) {
  const index = depositosSeleccionados.indexOf(valor);
  if (index === -1) { depositosSeleccionados.push(valor); boton.classList.add('active'); }
  else { depositosSeleccionados.splice(index,1); boton.classList.remove('active'); }
}

// ===== CONFIRMAR SELECCI√ìN Y REVISI√ìN =====
function confirmarSeleccion() {
  if (!depositosSeleccionados.length) { alert('‚ö†Ô∏è Selecciona al menos un dep√≥sito'); return; }
  if (!rutas.length) { alert('‚ö†Ô∏è No hay rutas cargadas'); return; }

  const rutasAgrupadas = depositosSeleccionados.flatMap(dep => 
    rutas.filter(r => r.deposito === dep)
          .sort((a,b) => (parseInt(b.columna||0)-parseInt(a.columna||0)) || 
                          (parseInt(b.nivell||0)-parseInt(a.nivell||0)) ||
                          (parseInt(b.contenedor||0)-parseInt(a.contenedor||0)))
  );

  rutasFiltradas = rutasAgrupadas;
  if (!rutasFiltradas.length) { alert('‚ö†Ô∏è No hay rutas para los dep√≥sitos seleccionados'); return; }

  actualIndex = 0;
  mostrarSiguienteCaja();
}

function mostrarSiguienteCaja() {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');

  if (actualIndex >= rutasFiltradas.length) { 
    document.getElementById('status').textContent = `‚úÖ Revisi√≥n completa: ${rutasConfirmadas.length} cajas procesadas`;
    mostrarModalFinal();
    return;
  }

  const r = rutasFiltradas[actualIndex];
  content.innerHTML = `
    <h3>Contenedor: ${r.contenedor}</h3>
    <p><strong>Arxiu:</strong> ${r.arxiu}</p>
    <p><strong>Dep√≥sito:</strong> ${r.deposito} | <strong>Pis:</strong> ${r.piso}</p>
    <p><strong>Carrer:</strong> ${r.carrer} | <strong>Columna:</strong> ${r.columna} | <strong>Nivell:</strong> ${r.nivell}</p>
    <p><strong>Fecha:</strong> ${r.fecha}</p>
    <div style="display:flex; gap:0.6rem; margin-top:1rem;">
      <button class="btn btn-primary" style="flex:1" onclick="confirmarCaja(true)">‚úÖ Caja encontrada</button>
      <button class="btn btn-secondary" style="flex:1" onclick="confirmarCaja(false)">‚ùå Caja no encontrada</button>
    </div>
  `;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

function confirmarCaja(encontrada) {
  const r = rutasFiltradas[actualIndex];
  r.estado = encontrada ? `‚úÖ Enviada a Odena ${r.fecha}` : `‚ùå No localizada ${r.fecha}`;
  rutasConfirmadas.push(r);

  const div = document.createElement('div');
  div.className = 'confirmada ' + (encontrada ? 'encontrada':'no-encontrada');
  div.innerHTML = `<strong>Contenedor:</strong> ${r.contenedor}<br>
    <strong>Arxiu:</strong> ${r.arxiu}<br>
    <strong>Dep√≥sito:</strong> ${r.deposito} | <strong>Pis:</strong> ${r.piso}<br>
    <strong>Carrer:</strong> ${r.carrer} | <strong>Columna:</strong> ${r.columna} | <strong>Nivell:</strong> ${r.nivell}<br>
    <strong>Estado:</strong> ${r.estado}<br>
    <strong>Origen:</strong> ${r.origen}`;
  document.getElementById('confirmadas').appendChild(div);

  actualIndex++;
  mostrarSiguienteCaja(); // No cerramos modal, solo actualizamos contenido
}

// ===== MODAL FINAL =====
function mostrarModalFinal() {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');

  content.innerHTML = `
    <h2>‚úÖ Revisi√≥n completada</h2>
    <p>El archivo ha sido generado correctamente. Elige una opci√≥n:</p>
    <div id="botonesDescarga"></div>
  `;

  descargarFinal(); // genera botones

  const recargarBtn = document.createElement('button');
  recargarBtn.textContent = 'üîÑ Cargar nuevo archivo';
  recargarBtn.className = 'btn btn-secondary';
  recargarBtn.style.width = '100%';
  recargarBtn.style.marginTop = '0.8rem';
  recargarBtn.onclick = abrirTrasRecarga;
  content.appendChild(recargarBtn);

  const salirBtn = document.createElement('button');
  salirBtn.textContent = 'üö™ Salir';
  salirBtn.className = 'btn btn-secondary';
  salirBtn.style.width = '100%';
  salirBtn.style.marginTop = '0.5rem';
  salirBtn.onclick = () => window.location.href = 'index.html';
  content.appendChild(salirBtn);

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

// ===== DESCARGA FINAL =====
function descargarFinal() {
  if (!rutasConfirmadas.length) { alert("‚ö†Ô∏è No hay rutas confirmadas"); return; }

  const contenido = rutasConfirmadas.map(r => (
    `Contenedor: ${r.contenedor}
Arxiu: ${r.arxiu}
Dep√≥sito: ${r.deposito} | Pis: ${r.piso}
Carrer: ${r.carrer} | Columna: ${r.columna} | Nivell: ${r.nivell}
Cliente: ${r.client}
Fecha: ${r.fecha}
C√≥digo de Barras: ${r.codigoBarras || ''}
Estado: ${r.estado}`
  )).join('\n\n');

  const fecha = new Date();
  const yyyy = fecha.getFullYear();
  const mm = String(fecha.getMonth()+1).padStart(2,'0');
  const dd = String(fecha.getDate()).padStart(2,'0');
  const nombreArchivo = `rutas_confirmadas_${yyyy}-${mm}-${dd}.dat`;

  const blob = new Blob([contenido], {type:'text/plain'});
  const url = URL.createObjectURL(blob);

  const div = document.getElementById('botonesDescarga');
  div.innerHTML = '';

  // Bot√≥n descargar
  const btnDownload = document.createElement('button');
  btnDownload.textContent = 'üì• Descargar archivo .dat';
  btnDownload.className = 'btn btn-primary';
  btnDownload.style.width='100%';
  btnDownload.style.marginTop='0.5rem';
  btnDownload.onclick = () => {
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),1000);
  };
  div.appendChild(btnDownload);

  // Gmail
  const btnGmail = document.createElement('button');
  btnGmail.textContent='üìß Enviar por Gmail';
  btnGmail.className='btn btn-secondary';
  btnGmail.style.width='100%';
  btnGmail.style.marginTop='0.5rem';
  btnGmail.onclick = ()=> window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=vegasf@outlook.com&su=Rutas confirmadas&body=Adjunto archivo generado: ${nombreArchivo}`,'_blank');
  div.appendChild(btnGmail);

  // Outlook/mailto
  const btnOutlook = document.createElement('button');
  btnOutlook.textContent='üì® Enviar por Outlook u otro';
  btnOutlook.className='btn btn-secondary';
  btnOutlook.style.width='100%';
  btnOutlook.style.marginTop='0.5rem';
  btnOutlook.onclick = ()=> window.location.href = `mailto:aradocartes@aradoc.cat?subject=Rutas confirmadas&body=Adjunto archivo generado: ${nombreArchivo}`;
  div.appendChild(btnOutlook);
}

// ===== UTIL =====
function cerrarModal() {
  const modal = document.getElementById('modal');
  modal.style.display='none';
  modal.setAttribute('aria-hidden','true');
}

function abrirTrasRecarga() {
  cerrarModal();
  localStorage.setItem('abrirInput','true');
  location.reload();
}

window.addEventListener('load', ()=>{
  if (localStorage.getItem('abrirInput')==='true'){
    localStorage.removeItem('abrirInput');
    document.getElementById('fileInput').click();
  }
});

function iniciarRevision() {
  if (!rutas.length) {
    alert('üìÇ Primero selecciona un archivo .dat o .pdf');
    return;
  }

  // Obtener todos los dep√≥sitos disponibles
  const depositos = [...new Set(rutas.map(r => r.deposito).filter(Boolean))];
  if (!depositos.length) {
    alert('‚ö†Ô∏è No hay dep√≥sitos v√°lidos en el archivo');
    return;
  }

  mostrarModalSeleccion(depositos);
}
document.getElementById('fileInput').addEventListener('change', async (event) => {
  const files = event.target.files;
  if (!files.length) return;

  rutas = []; // limpiar rutas anteriores
  document.getElementById('status').textContent = 'üìÇ Cargando archivos...';

  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();
    let texto = '';

    if (ext === 'dat') {
      texto = await file.text();
      rutas.push(...parsearRutas(texto, 'DAT'));
    } else if (ext === 'pdf') {
      texto = await leerPDF(file);
      rutas.push(...parsearRutas(texto, 'PDF'));
    }
  }

  document.getElementById('status').textContent = `‚úÖ ${rutas.length} rutas cargadas.`;
});

</script>

</body>
</html>