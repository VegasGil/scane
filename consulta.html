<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üì¶ Revisi√≥n de Rutas ‚Äî Rojo / Gris / Blanco</title>
  <style>
    :root{
      --brand-red: #ea0707; /* rojo marca */
      --brand-deep: #8b0000;
      --brand-mid: #727070;
      --brand-light: #f5f5f5;
      --white: #ffffff;
      --text: #222222;
    }

    *{box-sizing: border-box}
    body{
      margin:0; padding:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,var(--brand-light), #f7f7f7);
      color:var(--text);
      min-height:100vh;
      display:flex; flex-direction:column;
    }

    header{
      background: var(--brand-red);
      color:var(--white);
      padding:0.9rem 1rem;
      display:flex; align-items:center; gap:1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .brand {
      font-weight:700; font-size:1.05rem;
      letter-spacing:0.6px;
    }

    main{flex:1; padding:1rem; display:flex; flex-direction:column; align-items:center}

    .card{
      width:100%; max-width:980px; background:var(--white); border-radius:12px; padding:1rem;
      box-shadow:0 6px 20px rgba(0,0,0,0.04); margin-top:1rem;
    }

    #controls{display:flex; flex-direction:column; gap:0.75rem; align-items:center}

    /* custom file input */
    .file-wrap{width:100%; max-width:600px; display:flex; gap:0.75rem; align-items:center}
    .file-label{
      flex:1; display:flex; align-items:center; justify-content:center; gap:0.5rem;
      padding:0.9rem 1rem; border-radius:10px; background:var(--white);
      border:2px dashed var(--brand-mid); color:var(--brand-deep); cursor:pointer; font-weight:600;
    }
    .file-label:hover{background:#fff7f7}
    input[type=file]{display:none}

    .controls-row{display:flex; gap:0.75rem; width:100%; max-width:600px}
    .btn{flex:1; padding:0.9rem 1rem; border-radius:10px; border:none; cursor:pointer; font-weight:700}
    .btn-primary{background:var(--brand-red); color:var(--white)}
    .btn-secondary{background:var(--white); color:var(--brand-red); border:2px solid var(--brand-red)}

    #status{margin-top:0.75rem; font-weight:700; color:var(--brand-deep)}

    /* modal */
    #modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:999}
    #modalContent{width:100%; max-width:520px; background:var(--white); border-radius:14px; padding:1.25rem; box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    #modalContent h2{margin-top:0}

    /* deposit buttons (toggle) */
    .deposit-list{display:flex; flex-wrap:wrap; gap:0.6rem; justify-content:center; margin-top:0.6rem}
    .deposit-btn{padding:0.6rem 0.85rem; border-radius:10px; border:2px solid var(--brand-mid); background:var(--white); cursor:pointer; font-weight:700}
    .deposit-btn.active{background:var(--brand-red); color:var(--white); border-color:var(--brand-deep)}

    /* confirmadas list */
    #confirmadas{margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem; width:100%; max-width:980px}
    .confirmada{padding:0.95rem; border-radius:10px; font-weight:600}
    .confirmada.encontrada{background:linear-gradient(90deg,var(--white), #fffaf9); border-left:6px solid var(--brand-red); color:var(--text)}
    .confirmada.no-encontrada{background:#fff0f0; border-left:6px solid var(--brand-deep); color:var(--brand-deep)}

    footer{padding:1rem; text-align:center; color:#666; font-size:0.95rem}

    @media (max-width:700px){
      .controls-row{flex-direction:column}
      .file-wrap{flex-direction:column; align-items:stretch}
      .file-label{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="index.html" style="text-decoration: none; color: white;">ARADOC ARTES</a></div>
    <div style="margin-left:auto;font-weight:600;opacity:0.95">üì¶ Revisi√≥n de Rutas</div>
  </header>

  <main>
    <div class="card" role="region" aria-label="Controles principales">
      <div id="controls">
        <div class="file-wrap">
          <label class="file-label" for="fileInput">üìÅ Seleccionar archivo .dat</label>
          <input id="fileInput" type="file" accept=".dat,.pdf" multiple />
        </div>

        <div class="controls-row">
          <button class="btn btn-primary" onclick="mostrarModalFinal()">üì• Opciones / Descargar</button>
          <button class="btn btn-secondary" onclick="reiniciar()">üîÑ Reiniciar</button>
        </div>

        <div id="status">üìÇ Esperando archivo .dat...</div>
      </div>
    </div>

    <div id="confirmadas" aria-live="polite"></div>
    <div id="resumen" style="margin-top:2rem; font-weight:600;"></div>
  </main>

  <div id="modal" aria-hidden="true">
    <div id="modalContent"></div>
  </div>

  <footer>¬© 2025 ARADOC ARTES ‚Äî Colores corporativos: rojo ¬∑ gris ¬∑ blanco</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    // Variables globales (se mantienen entre recargas si lo deseas)
    let rutas = [];
    let rutasFiltradas = [];
    let rutasConfirmadas = [];
    let depositosSeleccionados = [];
    let actualIndex = 0;

    function filtrarPorDeposito(rutas, permitidos = ['45', '46', '47', '48', '49']) {
  const permitidas = [];
  const sinDeposito = [];

  rutas.forEach(r => {
    const deposito = r.deposito?.trim() || '';
    if (permitidos.includes(deposito)) {
      permitidas.push(r);
    } else if (deposito === '' || deposito === '0') {
      sinDeposito.push(r);
    }
  });

  return { permitidas, sinDeposito };
}
function analizarRutasDesdePDF(texto) {
  const bloques = texto.split(/Contenidor:/i); // separa por contenedor
  const rutasPDF = [];

  bloques.forEach(b => {
    const cont = b.match(/(\d+)/)?.[1] || '';
    const arxiu = b.match(/Arxiu:\s*(.+?)(\s|$)/)?.[1] || '';
    const deposito = b.match(/Dip√≤sit:\s*(\d+)/)?.[1] || '';
    const piso = b.match(/Pis:\s*(\d+)/)?.[1] || '';
    const carrer = b.match(/Carrer:\s*(\d+)/)?.[1] || '';
    const columna = b.match(/Columna:\s*(\d+)/)?.[1] || '';
    const nivell = b.match(/Nivell:\s*(\d+)/)?.[1] || '';

    if (cont && deposito) {
      rutasPDF.push({
        contenedor: cont,
        arxiu,
        deposito,
        piso,
        carrer,
        columna,
        nivell,
        origen: 'PDF'
      });
    }
  });

  return rutasPDF;
}

    // File input handling (hacemos click en la etiqueta para que funcione bonito)
    const fileInput = document.getElementById('fileInput');
    const fileLabel = document.querySelector('.file-label');
   

  fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const extension = file.name.split('.').pop().toLowerCase();

  if (extension === 'dat') {
    const text = await file.text();
    const rutasDAT = parsearRutas(text);
    const { permitidas, sinDeposito } = filtrarPorDeposito(rutasDAT);
    rutas = permitidas;
    rutasSinDeposito = sinDeposito;
    const depositosEncontrados = [...new Set(rutas.map(r => r.deposito))].sort((a,b) => b - a);
    if (depositosEncontrados.length === 0) {
      alert('No se han encontrado dep√≥sitos v√°lidos en el archivo.');
      return;
    }
    mostrarModalSeleccion(depositosEncontrados);
    console.log("Archivo DAT cargado:", file.name);
    console.log("Rutas detectadas:", rutas);
  }

  else if (extension === 'pdf') {
    const reader = new FileReader();
    reader.onload = async function () {
      const typedarray = new Uint8Array(this.result);
      try {
        const doc = await pdfjsLib.getDocument({ data: typedarray }).promise;
        let textoExtraido = [];
        for (let i = 1; i <= doc.numPages; i++) {
          const page = await doc.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str).join(' ');
          textoExtraido.push(strings);
        }
        const texto = textoExtraido.join('\n\n');
        const rutasPDF = analizarRutasDesdePDF(texto);
        const { permitidas, sinDeposito } = filtrarPorDeposito(rutasPDF);
        rutas = permitidas;
        rutasSinDeposito = sinDeposito;
        const depositosEncontrados = [...new Set(rutas.map(r => r.deposito))].sort((a,b) => b - a);
        if (depositosEncontrados.length === 0) {
          alert('No se han encontrado dep√≥sitos v√°lidos en el PDF.');
          return;
        }
        mostrarModalSeleccion(depositosEncontrados);
        console.log("Archivo PDF cargado:", file.name);
        console.log("Rutas detectadas:", rutas);
      } catch (err) {
        console.error(`‚ùå Error al cargar ${file.name}:`, err);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  else {
    alert('‚ö†Ô∏è Solo se permiten archivos .dat o .pdf');
  }
  function mostrarModalSeleccion(depositos) {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  depositosSeleccionados = [];

  let html = `<h2>Selecciona dep√≥sitos a revisar</h2>`;
  html += `<div class="deposit-list">`;
  depositos.forEach(d => {
    html += `<button class="deposit-btn" onclick="toggleDeposito('${d}', this)">Dep√≥sito ${d}</button>`;
  });
  html += `</div>`;

  // ‚úÖ Botones de acci√≥n
  html += `<div style="margin-top:1rem; display:flex; gap:0.6rem;">
    <button class="btn btn-primary" style="flex:1" onclick="confirmarSeleccion()">Comenzar revisi√≥n</button>
    <button class="btn btn-secondary" style="flex:1" onclick="cerrarModal()">Cancelar</button>
  </div>`;

  content.innerHTML = html;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}
});
    function toggleDeposito(valor, boton) {
      const index = depositosSeleccionados.indexOf(valor);
      if (index === -1) {
        depositosSeleccionados.push(valor);
        boton.classList.add('active');
      } else {
        depositosSeleccionados.splice(index, 1);
        boton.classList.remove('active');
      }
    }
function parsearRutas(texto) {
  const bloques = texto.split(/\n{2,}/);
  const rutas = [];

  bloques.forEach(b => {
    const cont = b.match(/Contenedor:\s*(\d+)/)?.[1] || '';
    const arxiu = b.match(/Arxiu:\s*(.+)/)?.[1] || '';
    const deposito = b.match(/Dep√≥sito:\s*(\d+)/)?.[1] || '';
    const piso = b.match(/Pis:\s*(\d+)/)?.[1] || '';
    const carrer = b.match(/Carrer:\s*(\d+)/)?.[1] || '';
    const columna = b.match(/Columna:\s*(\d+)/)?.[1] || '';
    const nivell = b.match(/Nivell:\s*(\d+)/)?.[1] || '';
    const fecha = b.match(/\d{2}\/\d{2}\/\d{4}/)?.[0] || '';

    if (cont && deposito) {
      rutas.push({
        contenedor: cont,
        arxiu,
        deposito,
        piso,
        carrer,
        columna,
        nivell,
        fecha,
        origen: 'DAT' // ‚úÖ Aqu√≠ se marca el origen
      });
    }
  });

  return rutas;
}
  function confirmarSeleccion() {
  if (depositosSeleccionados.length === 0) {
    alert('‚ö†Ô∏è Selecciona al menos un dep√≥sito para continuar.');
    return;
  }

  // Agrupar y ordenar rutas por dep√≥sito seleccionado
  const rutasAgrupadas = depositosSeleccionados.flatMap(deposito => {
    const grupo = rutas
      .filter(r => r.deposito === deposito)
      .sort((a, b) => {
        // Ordenar por columna, luego nivel, luego contenedor (de mayor a menor)
        return (
          (b.columna || 0) - (a.columna || 0) ||
          (b.nivell || 0) - (a.nivell || 0) ||
          (b.contenedor || 0) - (a.contenedor || 0)
        );
      });

    // üîß Parche de prueba: mostrar orden en consola
    console.log(`üì¶ Dep√≥sito ${deposito} - ${grupo.length} rutas ordenadas:`);
    grupo.forEach((r, i) => {
      console.log(`${i + 1}. Contenedor ${r.contenedor} | Columna ${r.columna} | Nivel ${r.nivell}`);
    });

    return grupo;
  });

  rutasFiltradas = rutasAgrupadas;

  if (rutasFiltradas.length === 0) {
    alert('‚ö†Ô∏è No hay rutas para los dep√≥sitos seleccionados. Selecciona otros dep√≥sitos.');
    return;
  }

  actualIndex = 0;
  cerrarModal();
  document.getElementById('status').textContent = `‚úÖ ${rutasFiltradas.length} cajas para revisar. Comenzando...`;
  setTimeout(mostrarSiguienteCaja, 500);
}

    function mostrarSiguienteCaja() {
      if (actualIndex >= rutasFiltradas.length) {
        document.getElementById('status').textContent = `‚úÖ Revisi√≥n completa: ${rutasConfirmadas.length} cajas procesadas`;
        mostrarModalFinal();
        return;
      }

      const ruta = rutasFiltradas[actualIndex];
      const modal = document.getElementById('modal');
      const content = document.getElementById('modalContent');

      content.innerHTML = `
        <h3>Contenedor: ${ruta.contenedor}</h3>
        <p><strong>Arxiu:</strong> ${ruta.arxiu}</p>
        <p><strong>Dep√≥sito:</strong> ${ruta.deposito} | <strong>Pis:</strong> ${ruta.piso}</p>
        <p><strong>Carrer:</strong> ${ruta.carrer} | <strong>Columna:</strong> ${ruta.columna} | <strong>Nivell:</strong> ${ruta.nivell}</p>
        <p><strong>Fecha:</strong> ${ruta.fecha}</p>
        <div style="display:flex; gap:0.6rem; margin-top:1rem;">
          <button class="btn btn-primary" style="flex:1" onclick="confirmarCaja(true)">‚úÖ Caja encontrada</button>
          <button class="btn btn-secondary" style="flex:1" onclick="confirmarCaja(false)">‚ùå Caja no encontrada</button>
        </div>
      `;

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function confirmarCaja(encontrada) {
      const ruta = rutasFiltradas[actualIndex];
      ruta.estado = encontrada ? `‚úÖ Enviada a Odena ${ruta.fecha}` : `‚ùå No localizada ${ruta.fecha}`;
      rutasConfirmadas.push(ruta);

      // Mostrar debajo
      const div = document.createElement('div');
      div.className = 'confirmada ' + (encontrada ? 'encontrada' : 'no-encontrada');
      div.innerHTML = `
  <strong>Contenedor:</strong> ${ruta.contenedor}<br>
  <strong>Arxiu:</strong> ${ruta.arxiu}<br>
  <strong>Dep√≥sito:</strong> ${ruta.deposito} | <strong>Pis:</strong> ${ruta.piso}<br>
  <strong>Carrer:</strong> ${ruta.carrer} | <strong>Columna:</strong> ${ruta.columna} | <strong>Nivell:</strong> ${ruta.nivell}<br>
  <strong>Estado:</strong> ${ruta.estado}<br>
  <strong>Origen:</strong> ${ruta.origen}
`;
      document.getElementById('confirmadas').appendChild(div);

      actualIndex++;
      cerrarModal();
      setTimeout(mostrarSiguienteCaja, 300);
    }
function filtrarBloques(texto) {
  const bloques = texto.split(/\n{2,}/); // separa por bloques
  const filtrados = bloques.filter(b => !b.includes('‚ùå No localizada'));
  return filtrados.join('\n\n');
}

// Ejemplo de uso:
const textoOriginal = `...`; // aqu√≠ va todo tu texto completo
const resultadoFiltrado = filtrarBloques(textoOriginal);
console.log(resultadoFiltrado);
    // === Funci√≥n que pediste que se volviera a a√±adir (descargarFinal) ===
    function descargarFinal() {
      if (rutasConfirmadas.length === 0) {
        alert("No hay rutas confirmadas a√∫n.");
        return null;
      }

      const contenido = rutasConfirmadas.map(r => {
        return `Contenedor: ${r.contenedor}\nArxiu: ${r.arxiu}\nDep√≥sito: ${r.deposito} | Pis: ${r.piso}\nCarrer: ${r.carrer} | Columna: ${r.columna} | Nivell: ${r.nivell}\n${r.estado}`;
      }).join('\n\n');

      const fecha = new Date();
      const yyyy = fecha.getFullYear();
      const mm = String(fecha.getMonth() + 1).padStart(2, '0');
      const dd = String(fecha.getDate()).padStart(2, '0');
      const nombreArchivo = `rutas_confirmadas_${yyyy}-${mm}-${dd}.dat`;

      const blob = new Blob([contenido], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);

      // Bot√≥n de descarga
      const descargarBtn = document.createElement('button');
      descargarBtn.textContent = 'üì• Descargar archivo .dat';
      descargarBtn.className = 'btn btn-primary';
      descargarBtn.style.width = '100%';
      descargarBtn.style.marginTop = '0.8rem';
      descargarBtn.onclick = () => {
        const link = document.createElement('a');
        link.href = url;
        link.download = nombreArchivo;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        // opcional: liberar el objeto URL despu√©s de un tiempo
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      };

      // Bot√≥n Gmail (abre compose; no adjunta autom√°ticamente)
      const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=vegasf@outlook.com&su=Rutas confirmadas&body=Adjunto archivo generado: ${nombreArchivo}`;
      const gmailBtn = document.createElement('button');
      gmailBtn.textContent = 'üìß Enviar por Gmail';
      gmailBtn.className = 'btn btn-secondary';
      gmailBtn.style.width = '100%';
      gmailBtn.style.marginTop = '0.5rem';
      gmailBtn.onclick = () => window.open(gmailLink, '_blank');

      // Bot√≥n Outlook / gen√©rico (mailto)
      const mailtoLink = `mailto:aradocartes@aradoc.cat?subject=Rutas confirmadas&body=Adjunto archivo generado: ${nombreArchivo}`;
      const outlookBtn = document.createElement('button');
      outlookBtn.textContent = 'üì® Enviar por Outlook u otro';
      outlookBtn.className = 'btn btn-secondary';
      outlookBtn.style.width = '100%';
      outlookBtn.style.marginTop = '0.5rem';
      outlookBtn.onclick = () => window.location.href = mailtoLink;

      return [descargarBtn, gmailBtn, outlookBtn];
    }

    function mostrarModalFinal() {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modalContent');
      content.innerHTML = `<h2>‚úÖ Revisi√≥n completada</h2><p>El archivo ha sido generado correctamente (si ya hay confirmaciones). Elige una opci√≥n:</p>`;

      const botones = descargarFinal();
      if (botones) {
        botones.forEach(btn => content.appendChild(btn));
      }

      const recargarBtn = document.createElement('button');
      recargarBtn.textContent = 'üîÑ Cargar nuevo archivo';
      recargarBtn.className = 'btn btn-secondary';
      recargarBtn.style.width = '100%';
      recargarBtn.style.marginTop = '0.8rem';
      recargarBtn.onclick = abrirTrasRecarga;
      content.appendChild(recargarBtn);

      const salirBtn = document.createElement('button');
      salirBtn.textContent = 'üö™ Salir';
      salirBtn.className = 'btn btn-secondary';
      salirBtn.style.width = '100%';
      salirBtn.style.marginTop = '0.5rem';
      salirBtn.onclick = () => window.location.href = 'index.html';
      content.appendChild(salirBtn);

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function abrirTrasRecarga() {
      localStorage.setItem('abrirInput', 'true');
      document.getElementById('modal').style.display = 'none'; // Oculta el modal antes de recargar
      location.reload();
    }

    function reiniciar() {
      rutas = [];
      rutasFiltradas = [];
      rutasConfirmadas = [];
      depositosSeleccionados = [];
      actualIndex = 0;

      document.getElementById('fileInput').value = '';
      document.getElementById('status').textContent = 'üìÇ Esperando nuevo archivo .dat...';
      document.getElementById('modal').style.display = 'none';
      document.getElementById('confirmadas').innerHTML = '';
    }

    function cerrarModal(){
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    // Mantener comportamiento de 'abrir input tras recarga' si se us√≥ antes
    window.addEventListener('load', () => {
      if (localStorage.getItem('abrirInput') === 'true') {
        localStorage.removeItem('abrirInput');
        document.getElementById('modal').style.display = 'none';
        document.getElementById('modalContent').innerHTML = '';
        document.getElementById('confirmadas').innerHTML = '';
        document.getElementById('status').textContent = 'üìÇ Esperando nuevo archivo .dat...';
        setTimeout(() => document.getElementById('fileInput').click(), 300);
      }

      // Permitir cerrar modal al hacer click fuera del contenido
      document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') cerrarModal();
      });
    });
    
  </script>
</body>
</html>